var datamagic=datamagic||{};datamagic.Binder=function(){this.payload={},this.callBack={},this.viewModel={},this.exclusions=[]},datamagic.Binder.prototype=function(){var attach=function(viewModel,exclusions,callBack){this.viewModel=viewModel,this.callBack=callBack,this.exclusions=exclusions,attachExtenders.call(this,viewModel,exclusions)},attachExtenders=function(obj,exclusions){var target=obj.extend?obj():obj;if(exclusions=exclusions||[],"[object Array]"===Object.prototype.toString.call(target))for(var i=0;i<target.length;i++)doAttachment.call(this,prop,target[i]),attachExtenders.call(this,target[i],exclusions);for(var prop in target)isKnockoutArray(target[prop])?(doAttachment.call(this,prop,target[prop]),attachExtenders.call(this,target[prop](),exclusions)):shouldTrack.call(this,prop,target)?doAttachment.call(this,prop,target[prop]):this.exclusions.indexOf(prop)<0&&this.exclusions.push(prop)},shouldTrack=function(prop,target){return!isExcludedProperty.call(this,prop)&&target[prop].extend?!0:!1},isExcludedProperty=function(prop){return ko.utils.arrayFirst(this.exclusions,function(item){return item===prop})?!0:!1},doAttachment=function(propertyName,observable){if(observable.extend){var options={name:propertyName,payload:this.payload,callBack:this.callBack,viewModel:this.viewModel,hydratePayload:hydratePayload,cleanPayload:cleanPayload,exclusions:this.exclusions};observable.extend({logChange:options})}};ko.extenders.logChange=function(target,options){isKnockoutArray(target)?target.subscribe(function(changes){"added"===changes[0].status&&attach(options.viewModel,options.exclusions,options.callBack),options.hydratePayload(options)},null,"arrayChange"):target.subscribe(function(){options.hydratePayload(options)})};var hydratePayload=function(options){options.payload=ko.toJS(options.viewModel),options.exclusions&&options.exclusions.length>0&&options.cleanPayload(options),options.payload&&options.callBack(options.payload)},cleanPayload=function(options){options.payload=deepCleanPayload(options.payload,options.exclusions)},deepCleanPayload=function(target,exclusions){for(var prop in target)if("[object Array]"===Object.prototype.toString.call(target[prop]))for(var i=0;i<target[prop].length;i++)target[prop][i]=deepCleanPayload.call(this,target[prop][i],exclusions);return target=removeExcludedProperties(target,exclusions)},removeExcludedProperties=function(target,exclusions){return ko.utils.arrayForEach(exclusions,function(exclude){delete target[exclude]}),target},isKnockoutArray=function(observable){return observable.push};return{attach:attach}}(),datamagic.dm=function(parameters){var self=this;return self.binder=parameters.binder||new datamagic.Binder,self.viewModel=parameters.viewModel,self.wire=parameters.wire,self.options=parameters.options,self.active=parameters.options.autoStart||!1,self.initialised=!1,self.init=function(){self.binder.attach(self.viewModel,self.options.exclusions||[],self.receiveUpdate),self.initialised=!0},self.start=function(){self.initialised||self.init(),self.active=!0},self.stop=function(){self.active=!1},self.receiveUpdate=function(data){self.active&&self.wire.saveData(data)},self.active&&self.init(),{start:self.start,stop:self.stop}};