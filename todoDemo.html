<html>
<head>
    <title>todo datamagic demo</title>
    <link href="http://bootswatch.com/readable/bootstrap.min.css" rel="stylesheet" type="text/css"/>

    <style>
        .completed{
            text-decoration: line-through;
        }

        #todo-count {
            display: block;
            padding: 10 15;
        }

        .active {
            background-color: #EEE;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="row">
        <div class="col-md-12">
            <h1 class="text-center">datamagic demo</h1>
            <p>The best way to see whats happening here is to open two browser windows at <a href="http://codescribler.github.io/Knockout.DataMagic/todoDemo.html" target="_blank"> this page.</a> Then add and remove items from the to do list!</p>
        </div>
    </div>

    <div class="row">
        <div class="well well-lg">
            <div class="row">
                <div class="col-md-12">
                    <h2>To Do List Demo</h2>
                </div>
            </div>

            <div class="row">
                <div class="col-md-12">
                    <fieldset>
                        <div class="form-group">
                            <input id="new-todo" class="form-control col-md-4" data-bind="value: current, valueUpdate: 'afterkeydown', enterKey: add" placeholder="What needs to be done?" autofocus>
                        </div>
                    </fieldset>
                </div>
            </div>
            <div class="row" data-bind="visible: loading">
                <div class="col-md-12">
                    <br/>
                    <div class="well">
                        <h2>Hold on to your hat, just loading your tasks ...</h2>
                    </div>
                </div>
            </div>
            <div class="row" data-bind="visible: todos().length">
                <div class="col-md-12">

                    <div class="checkbox">
                        <label>
                            <input id="toggle-all" data-bind="checked: allCompleted" type="checkbox"> Mark all as complete
                        </label>
                    </div>
                    <ul id="todo-list" data-bind="foreach: filteredTodos">
                        <li data-bind="css: { completed: completed }">
                            <div class="checkbox">
                                <label>
                                    <input class="toggle" data-bind="checked: completed" type="checkbox">
                                    <span data-bind="text: title"></span>
                                </label>
                                <a class="destroy" data-bind="click: $root.remove" title="Delete">x</a>
                            </div>
                        </li>
                    </ul>

                    <footer id="footer" data-bind="visible: completedCount() || remainingCount()">
                        <div class="col-md-3">

                            <span id="todo-count">
                                <strong data-bind="text: remainingCount">0</strong>
                                <span data-bind="text: getLabel(remainingCount)"></span> left
                            </span>

                        </div>
				        <div class="col-md-4 col-offset-6">
                            <ul id="filters" class="nav nav-pills">
                                <li>
                                    <a class="" data-bind="css: { active: showMode() == 'all' }, click: function(){showMode('all');}" href="#/all">All</a>
                                </li>
                                <li>
                                    <a class="" data-bind="css: { active: showMode() == 'active' }, click: function(){showMode('active');}" href="#/active">Active</a>
                                </li>
                                <li>
                                    <a class="" data-bind="css: { active: showMode() == 'completed' }, click: function(){showMode('completed');}" href="#/completed">Completed</a>
                                </li>
                            </ul>
                            <button id="clear-completed" class="btn btn-warning" data-bind="visible: completedCount, click: removeCompleted">
                                Clear completed (<span data-bind="text: completedCount"></span>)
                            </button>
                        </div>
                    </footer>

                </div>
            </div>


        </div>
    </div>


    <div class="row">
        <div class="col-md-12">
            <h3 class="text-center">What is actually happening here?</h3>
            <div class="col-md-6">
                <img src="images/datamagic.jpg" class="img-responsive" title="How datamagic works" alt="datamagic flow">
            </div>
            <div class="col-md-6">
                <p> The live sync bit is provided by Firebase, a real time database and the view binding by knockout.
                    DataMagic watches for changes to the model and pumps them up to Firebase who then syncs up between clients. Simple!</p>
                <p>This sample heavily borrows from the <a href="http://todomvc.com/" title="todomvc project">todomvc</a> project in order to demonstrate DataMagic in action!</p>
            </div>
        </div>
    </div>
</div>

<script src="javascripts/jquery-1.10.2.min.js" type="text/javascript"> </script>
<script src="javascripts/bootstrap.min.js" type="text/javascript"> </script>
<script src="javascripts/knockout-3.0.0.js" type="text/javascript"> </script>
<script src="javascripts/firebase/firebase.js" type="text/javascript"> </script>
<script src="javascripts/datamaigic/knockout-datamagic.js" type="text/javascript"> </script>

<script>
// Direct copy from: https://raw.github.com/tastejs/todomvc/gh-pages/architecture-examples/knockoutjs/js/app.js
(function () {
    'use strict';

    var ENTER_KEY = 13;
    var ESCAPE_KEY = 27;

    // A factory function we can use to create binding handlers for specific
    // keycodes.
    function keyhandlerBindingFactory(keyCode) {
        return {
            init: function (element, valueAccessor, allBindingsAccessor, data, bindingContext) {
                var wrappedHandler, newValueAccessor;

                // wrap the handler with a check for the enter key
                wrappedHandler = function (data, event) {
                    if (event.keyCode === keyCode) {
                        valueAccessor().call(this, data, event);
                    }
                };

                // create a valueAccessor with the options that we would want to pass to the event binding
                newValueAccessor = function () {
                    return {
                        keyup: wrappedHandler
                    };
                };

                // call the real event binding's init function
                ko.bindingHandlers.event.init(element, newValueAccessor, allBindingsAccessor, data, bindingContext);
            }
        };
    }

    // a custom binding to handle the enter key
    ko.bindingHandlers.enterKey = keyhandlerBindingFactory(ENTER_KEY);

    // another custom binding, this time to handle the escape key
    ko.bindingHandlers.escapeKey = keyhandlerBindingFactory(ESCAPE_KEY);

    // wrapper to hasFocus that also selects text and applies focus async
    ko.bindingHandlers.selectAndFocus = {
        init: function (element, valueAccessor, allBindingsAccessor, bindingContext) {
            ko.bindingHandlers.hasFocus.init(element, valueAccessor, allBindingsAccessor, bindingContext);
            ko.utils.registerEventHandler(element, 'focus', function () {
                element.focus();
            });
        },
        update: function (element, valueAccessor) {
            ko.utils.unwrapObservable(valueAccessor()); // for dependency
            // ensure that element is visible before trying to focus
            setTimeout(function () {
                ko.bindingHandlers.hasFocus.update(element, valueAccessor);
            }, 0);
        }
    };

    // represent a single todo item
    var Todo = function (title, completed) {
        this.title = ko.observable(title);
        this.completed = ko.observable(completed || false);
    };

    // our main view model
    var ViewModel = function () {
        // map array of passed in todos to an observableArray of Todo objects
        this.todos = ko.observableArray();

        // store the new todo value being entered
        this.current = ko.observable();

        this.showMode = ko.observable('all');

        this.loading = ko.observable(true);

        this.filteredTodos = ko.computed(function () {
            switch (this.showMode()) {
                case 'active':
                    return this.todos().filter(function (todo) {
                        return !todo.completed();
                    });
                case 'completed':
                    return this.todos().filter(function (todo) {
                        return todo.completed();
                    });
                default:
                    return this.todos();
            }
        }.bind(this));

        // add a new todo, when enter key is pressed
        this.add = function () {
            var current = this.current().trim();
            if (current) {
                this.todos.push(new Todo(current));
                this.current('');
                if(this.todos().length > 9){
                    this.todos.remove(this.todos()[0]); // Kill the first item
                }
            }
        }.bind(this);

        // remove a single todo
        this.remove = function (todo) {
            this.todos.remove(todo);
        }.bind(this);

        // remove all completed todos
        this.removeCompleted = function () {
            this.todos.remove(function (todo) {
                return todo.completed();
            });
        }.bind(this);

        // count of all completed todos
        this.completedCount = ko.computed(function () {
            return this.todos().filter(function (todo) {
                return todo.completed();
            }).length;
        }.bind(this));

        // count of todos that are not complete
        this.remainingCount = ko.computed(function () {
            return this.todos().length - this.completedCount();
        }.bind(this));

        // writeable computed observable to handle marking all complete/incomplete
        this.allCompleted = ko.computed({
            //always return true/false based on the done flag of all todos
            read: function () {
                return !this.remainingCount();
            }.bind(this),
            // set all todos to the written value (true/false)
            write: function (newValue) {
                this.todos().forEach(function (todo) {
                    // set even if value is the same, as subscribers are not notified in that case
                    todo.completed(newValue);
                });
            }.bind(this)
        });

        // helper function to keep expressions out of markup
        this.getLabel = function (count) {
            return ko.utils.unwrapObservable(count) === 1 ? 'item' : 'items';
        }.bind(this);
    };

    // bind a new instance of our view model to the page
    var vm = new ViewModel([]);
    ko.applyBindings(vm);

    var options = {
        baseUrl     : "https://datamagic.firebaseIO.com/todos",
        exclusions  : ["current", "filteredTodos", "completedCount", "remainingCount", "allCompleted", "loading"],
        autoStart: false
    };

    var binder = new datamagic.Binder();
    var provider = new datamagic.dm({binder: binder, viewModel: vm, wire: new datamagic.FireWire(), options: options});
    provider.start();


    var dataRef = new Firebase(options.baseUrl);
    dataRef.on('value', function(snapshot) {
        //alert(snapshot.val());
        var model = snapshot.val();
        vm.loading(false);
        provider.stop();
        if(model) {
            vm.showMode(model.showMode || "All");
            if(model.todos){
                vm.todos(model.todos.map(function (todo) {
                    return new Todo(todo.title, todo.completed);
                }));
            }
        }
        provider.start();
    });

}());

</script>

</body>
</html>